<!DOCTYPE html>
<html>
    <head>
        <title>DSM2 version 8.2 : DSM2 Bay-Delta Tutorial 4: Batch Preprocessing</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">DSM2 version 8.2</a></span>
                            </li>
                                                    <li>
                                <span><a href="DSM2_87228545.html">DSM2</a></span>
                            </li>
                                                    <li>
                                <span><a href="Tutorials_87228717.html">Tutorials</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            DSM2 version 8.2 : DSM2 Bay-Delta Tutorial 4: Batch Preprocessing
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Nicky Sandhu</span>, last modified on Jan 27, 2021
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h2 id="DSM2BayDeltaTutorial4:BatchPreprocessing-Purpose:ThistutorialwilldemonstratehowtopreprocessanumberofCalSimoutputfiles,eachofwhichrepresentsadifferentalternative–wewilllookatthreealternatives,butthetechniquesapplytolargenumbersofalternativesjustaswell.Inth">Purpose: <strong><em>This tutorial will demonstrate how to</em></strong> <strong><em>preprocess a</em></strong> <strong><em>number of CalSim output files, each of which represents a different alternative – we will look at three alternatives, but the techniques apply to large numbers of alternatives just as well. In the process of this tutorial, you</em></strong> <strong><em>should become more familiar with how DSM2 and CalSim label their simulations and scenarios and a learn a little bit about batch files</em></strong></h2><h2 id="DSM2BayDeltaTutorial4:BatchPreprocessing-CalSimFiles:AtypicalsituationwithplanningstudiesisthattheinputscenariosarerepresentedbydifferentCalSimoutputfiles.Sometimesthesefilesresideinadirectorystructurethatfollowsapattern,forinstancethefirsttwoalternatives">CalSim Files: <strong><em>A typical situation with planning studies is that the input scenarios are represented by different</em></strong> <strong><em>CalSim output files. Sometimes these files reside in a directory structure that follows a pattern, for instance the first two alternatives might look like this:</em></strong></h2><h2 id="DSM2BayDeltaTutorial4:BatchPreprocessing-C:/calsim"><strong><em>C:/calsim</em></strong></h2><p>/altname1<br/>/dss<br/>/d1641<br/>2020d09edvsa.dss<br/>/altname2<br/>/dss<br/>/d1641<br/>2020d09edvsa.dss <br class="atl-forced-newline"/>Note that this scheme CalSim uses directory structure to differentiate its output – the files and pathnames are identical. <br class="atl-forced-newline"/>Another system you may encounter is one where the CalSim files themselves are named after the scenario:</p><h2 id="DSM2BayDeltaTutorial4:BatchPreprocessing-C:/calsim.1"><strong><em>C:/calsim</em></strong></h2><p>/altname1_2020d09edvsa.dss<br/>/altname2_2020d09edvsa.dss</p><h2 id="DSM2BayDeltaTutorial4:BatchPreprocessing-Preprocessorrequirements:">Preprocessor requirements:</h2><p>The DSM2 preprocessing scheme requires three pieces of information for each scenario:</p><ol><li>The DSM2 name we want to give the scenario (will become DSM2MODIFIER).</li><li>The directory in which the CalSim output is found (will become CALSIMDIR)</li><li>The name of the CalSim file (minus the .dss part – will become CALSIMNAME)</li></ol><p><br class="atl-forced-newline"/>So for the first example above<br/>DSM2MODIFIER=altname1<br/>CALSIMNAME=2020d09edvsa<br/>CALSIMDIR= c:/calsim/altname1/dss/d1641<br/>How you will get this information into the preprocessing system depends on approach. We will look at two, but if you are an experienced script writer you will immediately see lots of possibilities.</p><h2 id="DSM2BayDeltaTutorial4:BatchPreprocessing-Twoapproachesforbatchjobs:">Two approaches for batch jobs:</h2><p>For larger studies, you have some choices as to how to set things up. We'll look at a few that may help you get started, while experienced script writers are likely to come up with numerous interesting variations. These exercises will guide you in setting up modest batch processing and familiarize you a bit more with the concept of environmental variables at the command line and in windows &quot;batch&quot; scripts (files with a *.bat extension that list commands for the command line).</p><ol><li>You can create configuration files for each alternative, e.g. <em>config_alt1.inp</em>, <em>config_alt2.inp</em>. In each configuration file you hard-wire the information that is required is hardwired for that scenario. This method record of each scenario for people who inherit your study. It is a good choice when the number of alternatives is small. It is also a good choice when things other than CalSim vary between alternatives.</li><li>Alternatively, you can create a single configuration file that points the three scenario-related variables to generic values. Then you use a batch_prepro.bat script to loop through the scenarios. When the number of simulations is very large (say 100 climate change scenarios) and the only difference in the inputs is CalSim, this method is efficient.</li></ol><p><br class="atl-forced-newline"/>Now let's go through the exercises and check out the details.</p><h2 id="DSM2BayDeltaTutorial4:BatchPreprocessing-Method1:Usingseparateconfigurationfiles:">Method 1: Using separate configuration files:</h2><ol><li><strong>Create the configuration files:</strong><ol><li>In windows, navigate to <em>\\{DSM2_home}\tutorial\ocap_sdip</em>. The alternatives we are using have generic sounding names, but they are compatible with OCAP assumptions.</li><li>Copy the configuration file config_sdip_ocap_71.inp to config_alt1.inp</li><li>Make sure the study dates cover the full 1974-1991 period for planning runs. It is usually a good idea to preprocess the whole period, even if you are going to do run dsm2 on a subset of the simulation period.</li><li>Replace the three variables indicated below. The three lines may not be next to one another.</li></ol></li></ol><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p><p>&lt;file config_alt1.inp&gt;<br/>
ENVVAR<br/>
NAME          VALUE<br/>
[other definitions…]             # <strong>NOTE: LINES SHOWN MAY NOT</strong> </p></p><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><ul><li><ol><li>BE TOGETHER*<br/>CALSIMNAME 2005a01edv # File name, minus .dss <br/>DSM2MODIFIER alt1 # DSM2 name for alternative<br/>CALSIMDIR ..data/calsim/alt1 # CalSim output directory<br/>END</li></ol></li></ul><ol><li><ol><li>Copy the file config_alt1.inp to config_alt2.inp. Repeat step (d) using alt2 as the DSM2MODIFIER.</li><li>Prepare <em>hydro.inp</em> and <em>qual.inp</em> to handle a generic configuration file by making the name of the configuration file at the top of each an ENVVAR. We will be providing this from the command line or batch file – as an operating system environmental variable.</li></ol></li></ol><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p><p>&lt;file hydro.inp&gt;<br/>
CONFIGURATION<br/>
${CONFIGFILE}      # Changed<br/>
END<br/>
… [other data]
<br class="atl-forced-newline" /></p></p><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><ol><li><ol><li>Prepare a batch file for preprocessing. It will have one line per alternative. Notice the &quot;call&quot; statement – this is the best way to call a succession of other batch files (prepro is itself a batch file called prepro.bat).</li></ol></li></ol><p>&lt;file study_prepro.bat&gt;<br/>call prepro config_alt1.inp<br/>call prepro config_alt2.inp <br class="atl-forced-newline"/><br class="atl-forced-newline"/></p><ol><li><ol><li>At the command prompt, launch the preprocessing by typing:</li></ol></li></ol><p>&gt; study_prepro.bat</p><ol><li><ol><li>Now create a batch file that launches QUAL and HYDRO for every alternative in the study. For each alternative, you must set the environment variable CONFIGFILE, then launch the models.</li></ol></li></ol><p>&lt;file study.bat&gt;<br/>SET CONFIGFILE=config_alt1.inp<br/>hydro hydro.inp<br/>qual qual_ec.inp<br/>SET CONFIGFILE=config_alt2.inp<br/>hydro hydro.inp<br/>qual qual_ec.inp</p><ol><li><ol><li>Launch the study batch file by typing at the command prompt:</li></ol></li></ol><p>&gt; study.bat</p><h2 id="DSM2BayDeltaTutorial4:BatchPreprocessing-Method2:Batchfilethatloops">Method 2: Batch file that loops</h2><ol><li>*Create a generic configuration file:*<ol><li>In the looping method, we are going to describe the alternatives in a text file and loop through the text file. First we need a configuration file that is generic. Let's begin by copying <em>config_sdip_ocap_71.inp</em> one more time to a file called <em>config_study.inp</em>. Change the 3 variables (DSM2MODIFIER, CALSIMNAME and CALSIMDIR) as follows.</li></ol></li></ol><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p><p><br class="atl-forced-newline" />
&lt;file config_study.inp&gt;<br/>
ENVVAR<br/>
NAME          VALUE<br/>
[other definitions…]<br/>
CALSIMNAME    ${BATCH_CALSIMNAME} # File name, minus .<br/>
DSM2MODIFIER  ${BATCH_DSM2MODIFIER}                                                                                                                                                                          <br/>
CALSIMDIR     ${BATCH_CALSIMDIR}  # CalSim output directory<br/>
dss      </p></p><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><ol><li><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p><p>DSM2 name for alternative<br/>
[other definitions…]<br/>
END</p></p><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p /><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p></li></ol><p><br class="atl-forced-newline"/><br class="atl-forced-newline"/></p><ol><li><strong>Create the scenarios.txt file</strong><ol><li>In the study folder, create a file called scenarios.txt</li><li>On each line of the file, put the scenario name (DSM2MODIFIER), directory (CALSIMDIR) and file name (CALSIMNAME) minus the &quot;.dss&quot; extension.</li></ol></li></ol><p><br class="atl-forced-newline"/>&lt;file scenarios.txt&gt;<br/>alt1,../data/calsim/alt1,2005a01edv<br/>alt2,../data/calsim/alt2,2005a01edv</p><p><br/></p><ol><li><strong>Launch batch_prepro.bat</strong><ol><li>In the study directory, obtain a command prompt and type:</li></ol></li></ol><p>&gt; batch_prepro config_study.inp scenarios.txt</p><ol><li><ol><li>Note: if the batch_prepro script fails for a particular scenario after running others successfully, first fix the problem and eliminate the failed (half-processed) scenario. Then avoid re-running the successful scenarios by adding the &quot;resume&quot; tag, for example:</li></ol></li></ol><p>&gt; batch_prepro config_study.inp scenarios.txt resume<br/>If you type this command now, batch_prepro.bat will harmlessly do nothing.</p><ol><li><strong>Examine and use the preprocessing products</strong><ol><li>The preprocessing product is a HEC-DSS file for each scenario in the local time series directory. You should have one file per scenario.</li><li>If you are doing this tutorial on your own, you may choose to launch dsm2 on each alternative. To do this, change the configuration file in <em>hydro.inp</em> and <em>qual_ec.inp</em> to the generic one:</li></ol></li></ol><p>&lt;file hydro.inp&gt;<br/>CONFIGURATION<br/>config_study.inp <br/>END</p><ol><li><ol><li>Use batch_run.bat with the same syntax as you did for batch_prepro::</li></ol></li></ol><p>&gt; batch_run config_study.inp<br/>Note that you may need to modify this script if you use it for something other than qual_ec. We may not be able to run the simulations in class because of the time required – but if you have extra time, change the dates to a one year (1991) and try it out.</p>
                    </div>

                                        
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on May 16, 2023 11:04</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
