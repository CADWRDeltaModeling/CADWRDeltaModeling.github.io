<!DOCTYPE html>
<html>
    <head>
        <title>DSM2 version 8.2 : DSM2 Bay-Delta Tutorial 1: Historical Simulation</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">DSM2 version 8.2</a></span>
                            </li>
                                                    <li>
                                <span><a href="DSM2_87228545.html">DSM2</a></span>
                            </li>
                                                    <li>
                                <span><a href="Tutorials_87228717.html">Tutorials</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            DSM2 version 8.2 : DSM2 Bay-Delta Tutorial 1: Historical Simulation
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Nicky Sandhu</span> on Jan 27, 2021
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h1 id="DSM2BayDeltaTutorial1:HistoricalSimulation-Purpose:">Purpose:</h1><p>This tutorial will demonstrate how to launch a basic run of the historical HYDRO and QUAL simulations.You will also get practice using the study templates that are distributed with DSM2, see how the configuration file is used, make some changes in the output and learn about the post-processing &quot;transfer&quot; script for averaging your output.</p><p>Except as part of a re-calibration, it is rare to make big changes in the historical simulation. More commonly, you will want to add a few output locations or scalars. Large scale policy or physical changes are usually analyzed within a Planning simulation framework, covered in a later tutorial.</p><h2 id="DSM2BayDeltaTutorial1:HistoricalSimulation-HYDROandQUAL">HYDRO and QUAL</h2><ol><li><strong>Copy the historical template:</strong><ol><li>In windows, copy the folder<span> </span><em>\\{DSM2_home}\study_template\historical</em><span> </span>to the tutorial directory, after creating<span> </span><em>\\{DSM2_home}\tutorials\historical</em>. If there is already a historical folder, just copy the contents.</li><li>Open<span> </span><em>historical_hydro.inp</em><span> </span>and<span> </span><em>historical_qual_ec.inp.</em><span> </span>Note the CONFIGURATION sections of both reference a file<span> </span><em>configuration_historical.inp</em>. By containing variables such as run dates in this file, you can more easily synchronize the models.</li><li>Examine the<span> </span><em>common_input</em><span> </span>directory. By looking at<span> </span><em>historical_hydro.inp, configuration_historical.inp</em><span> </span>and the other main input files, you will see that many of the included files for the models are in the directory ${DSM2INPUTDIR}. In this distribution, this variable points to<span> </span><em>/dsm2/common_input</em><span> </span>– a repository in which all the distributed DSM2 input files are housed. Later, you may want to copy the input files locally and repoint ${DSM2INPUTDIR} to this local directory. In fact, there are tools to help with this. Regardless of whether you copy them, please resist changing the files directly – it is much easier to diagnose problems if you make your changes in the main file (<em>historical_hydro.inp, historical_qual_ec.inp</em>…) or in a new file of your own making.</li></ol></li><li><strong>Modify the Run Times in the Configuration File:</strong></li></ol><p>In the configuration file, set the runtime definitions as follows.</p><p>#runtime<br/>START_DATE 01JUL1996<br/>START_TIME 0000<br/>QUAL_START_DATE 02JUL1996<br/>PTM_START_DATE ${QUAL_START_DATE}<br/>END_DATE 01SEP1996<br/>END_TIME 0000<span> </span></p><ol><li><strong>Note the Output Step in HYDRO:</strong></li></ol><p>If you look in the channel output files (e.g.<span> </span><em>output_channel_std_hydro_rki_20090715.inp)</em>, you will find that the time step of the output is itself an ENVVAR definition called ${FINE_OUT}. This is usually defined as 15 minutes in configuration file. Although DSM2 v8 will perform daily averages, it is recommended that you use the finer output and aggregate as a postprocessing step (we will cover this shortly).</p><ol><li><strong>Add some Output</strong></li></ol><p>In historical_hydro.inp, add a block containing an extra flow output for Old River at Head. Notice that the name in this case is a &quot;practical&quot; name. Although you may sometimes add input with names like &quot;ch56_0&quot;, such a name is redundant with the other information in the line, is difficult for non-modelers to understand and causes confusion if the grid numbering changes.<br/><br class="atl-forced-newline"/>OUTPUT_CHANNEL<br/>NAME CHAN_NO DISTANCE VARIABLE INTERVAL PERIOD_OP FILE<span> </span><br/>oldr_head 56 0 flow ${FINE_OUT} inst ${HYDROOUTDSSFILE}<span> </span><br/>END<span> </span></p><ol><li><strong>Run HYDRO and QUAL:</strong><ol><li>In Windows Explorer, navigate to the directory, _\\{DSM2_home}\tutorial_</li><li>Right-click on the<span> </span><em>historical</em><span> </span>directory, and select,<span> </span><em>Open Command Window Here.</em></li><li>In the command window, type:<span> </span><em>hydro historical_hydro.inp</em></li><li>Wait for HYDRO to complete its runs.</li><li>Now type:<span> </span><em>qual</em><span> </span><em>historical_qual_ec.inp</em></li></ol></li></ol><p><br/></p><ol><li><strong>Aggregate the Output</strong></li></ol><p>Above we recommended that you use post-processing to aggregate your output. Let's see how this works. At a command prompt in the ${study}/output directory, type:<br/>&gt; transfer -–help<br/>This command should give you the options for the &quot;transfer.py&quot; script that will help you aggregate your output.<span> </span><br class="atl-forced-newline"/>For instance, if you want to create a daily average of all your flow output, type (this is all one line):<span> </span><br class="atl-forced-newline"/>&gt;transfer --out=postpro.dss --selection=///FLOW////<span> </span><br/>--transform=period_ave --interval=1DAY historical.dss<span> </span><br class="atl-forced-newline"/>As another example, you may want to take a Godin average of all the stage output and put it in the same file:<span> </span><br class="atl-forced-newline"/>&gt;transfer --out=postpro.dss --selection=///STAGE////<span> </span><br/>--transform=godin historical.dss<span> </span><br class="atl-forced-newline"/>You can similarly do monthly averages by making the interval 1MON and you can &quot;slice&quot; in time by specifying a time window (the syntax is given by the help command:<br/>&gt; transfer -–help<span> </span></p><ol><li><strong>Running QUAL with Volumetric fingerpringting:</strong><ol><li>In the command window, type:<span> </span><em>qual historical_qual_vol.inp</em>.</li><li>Open the qual echo file qual_vol_echo_historical.inp in the output subfolder.</li><li>Open the results file in the output subfolder, and examine the results.</li></ol></li></ol><p><br/></p><ol><li><strong>Running QUAL with Nonconservative Constituents fingerpringting:</strong><ol><li>In Windows Explorer, navigate to the directory,<span> </span><em>\\{DSM2_home}\study_template_ _historical_qual_do</em>\. Conduct a similar study as EC and VOL.</li><li>Notice that the running time period is 1996-2000, since Stockton effluent is not using '<em>constant'</em><span> </span>but detailed timeseries:<span> </span><em>effluentflow96-2000.dss</em></li></ol></li></ol><p>ENVVAR<br/>NAME VALUE<span> </span><br/>STOCKTON_FLOW_FILE ${TSINPUTDIR}/effluentflow96-2000.dss # needed for DO runs, if not available use constant<br/>END</p><ol><li><ol><li>Open the results file in the output subfolder, and examine the results.</li></ol></li></ol><p><br/></p><h2 id="DSM2BayDeltaTutorial1:HistoricalSimulation-ParticleTrackingModeling(PTM)">Particle Tracking Modeling (PTM)</h2><p><br/></p><ol><li><strong>Run PTM in Delta Grid under Historical Condition</strong><ol><li>In Windows Explorer, navigate to the directory, _<br class="atl-forced-newline"/><br/><span class="error" style="color: rgb(51,51,51);">Unknown macro: {DSM2_home}{_}</span>tutorial\; in the command window, type:<span> </span>ptm historical_ptm.inp. *If necessary, reduce the running time period by modifying<span> </span><em>END_DATE</em><span> </span>in<span> </span><em>configuration_historical.inp</em>.</li><li>Open the ptm echo file ptm_echo_historical.inp in the output subfolder and examine the contents.</li><li>Open the ptmout.dss file in the output subfolder, and examine the results. Do a little mass balance to see if the particle fluxes add up.</li></ol></li></ol><p><br/></p><ol><li><strong>Repeat with Particle Filter on Channel Turned on:</strong></li></ol><p>Set particle filter at Head of Old River<span> </span></p><ol><li><ol><li>In historical_ptm.inp, create the table for particle filter, with constant closing operation.</li></ol></li></ol><p><br class="atl-forced-newline"/>PARTICLE_FILTER<br/>NAME NODE AT_WB FILLIN FILE PATH<br/>Filter_HOR 8 chan:54 last constant 0<br/>END<span> </span></p><ol><li><ol><li>Add the related output, like</li></ol></li></ol><p><br class="atl-forced-newline"/>PARTICLE_FLUX_OUTPUT<br/>NAME FROM_WB TO_WB INTERVAL FILE<br/>SJR-OLD chan:7 chan:54 15min ${PTMOUTPUTFILE}<br/>END<span> </span></p><ol><li><ol><li>Open the ptmout.dss file in the output subfolder, and examine the results</li></ol></li></ol><p><br class="atl-forced-newline"/><br class="atl-forced-newline"/></p><ol><li><strong>Repeat with Particle Filter on Reservoir Turned on:</strong></li></ol><p>With particle filter installed at Clifton Court Forebay (this is a special version of filter dealing with source flows directly connecting to reservoir)<span> </span></p><ol><li><ol><li>In historical_ptm.inp, create the table for particle filter, with time-varying operation control, specified in DSS file.</li></ol></li></ol><p><br class="atl-forced-newline"/>PARTICLE_RES_FILTER<br/>NAME RES_NAME AT_WB FILLIN FILE PATH<br/>clfc_div_bbid clifton_court qext:dicu_div_bbid last ./filterOp.dss /HIST+FILTER/CLFC_DIV/FILTER_OP//IR-DECADE/DWR-BDO/<br/>END<span> </span></p><ol><li><ol><li>Add the related output, like</li></ol></li></ol><p><br class="atl-forced-newline"/>PARTICLE_FLUX_OUTPUT<br/>NAME FROM_WB TO_WB INTERVAL FILE<br/>SWP-AG res:clifton_court group:bbid 15min ${PTMOUTPUTFILE}<span> </span><br/>END<span> </span></p><ol><li><ol><li>Open the ptmout.dss file in the output subfolder, and examine the results</li></ol></li></ol><p><br class="atl-forced-newline"/><br class="atl-forced-newline"/></p><ol><li><strong>Repeat with Particle Filter on Source Flow Turned on:</strong></li></ol><p>Agriculture source flow (diversions and seepages) could be required to restrict particles from entering in simulations. It is one application for particle filter.<span> </span></p><ol><li><ol><li>In Windows Explorer, navigate to the directory, \\{DSM2_home}\tutorial\. Open the file<span> </span><em>delta_dicu_filter_closed.txt</em>. Copy the content into historical_ptm.inp</li></ol></li></ol><p><br/></p><ol><li><ol><li>Open the ptmout.dss file in the output subfolder, and examine the results</li></ol></li></ol><p><br class="atl-forced-newline"/><br class="atl-forced-newline"/></p><h2 id="DSM2BayDeltaTutorial1:HistoricalSimulation-MakinganimationofParticleTrackingModeling(PTM)">Making animation of Particle Tracking Modeling (PTM)</h2><p><br/></p><ol><li><strong>Modify the PTM input file to make text output and to turn on the dispersion parameters:</strong><ol><li>In Windows Explorer, copy the folder<span> </span><em>ptm_animate</em><span> </span>(with subfolders) from<span> </span><em>\\{DSM2_home}\study_templates\ptm_animate</em></li></ol></li></ol><p>to the study directory, creating:<br/><em>\\{DSM2_home}\tutorials\historical\ptm_animate</em></p><ol><li><ol><li>With the PTM, it is useful to be able to switch easily between text and dss output formats – note that the animator requires text files. The<span> </span><em>configuration_historical.inp</em><span> </span>file is structured so that we can swap the environmental variable<span> </span><em>PTMOUTPUTFILE</em>. We are going to point<span> </span><em>PTMOUTPUTFILE</em><span> </span>to txt format so we can use the animator.<ol><li><ol><li>Locate the<span> </span><em>PTMOUTPUTFILE</em><span> </span>at the end of the file, and modify as:</li></ol></li></ol></li></ol></li></ol><p>PTMOUTPUTFILE ptmout.txt</p><ol><li><ol><li>Open the file,<span> </span><em>historical_ptm.inp</em>.<ol><li>Locate the SCALARS section. Check all of the dispersion parameters to be<span> </span><em>t</em>.</li></ol></li></ol></li></ol><p>ptm_ivert<span> </span><em>t</em><span> </span># Use Vertical velocity profile<br/>ptm_itrans<span> </span><em>t</em><span> </span># Use Transverse velocity profile<br/>ptm_iey<span> </span><em>t</em><span> </span># Use transverse mixing<br/>ptm_iez<span> </span><em>t</em><span> </span># Use vertical mixing</p><ol><li><ol><li><ol><li>Make sure the<span> </span><em>anim_db.bin</em><span> </span>line is turned on (this is usually commented out to save much running time)</li></ol></li></ol></li></ol><p>ptm anim out 15min ${DSM2OUTPUTDIR}/anim_db.bin<span> </span><br class="atl-forced-newline"/><br class="atl-forced-newline"/></p><ol><li><strong>Run PTM:</strong><ol><li>In the command window, type:<span> </span><em>ptm historical_ptm.inp</em>.</li><li>In Windows Explorer:<ol><li>Navigate to the directory,</li></ol></li></ol></li></ol><p><em>\\{DSM2_home}\tutorials\historical\output</em></p><ol><li><ol><li><ol><li>Examine the output in the<span> </span><em>ptmout.txt</em><span> </span>file.</li><li>Copy the files,<span> </span><em>anim_db.bin</em><span> </span>and<span> </span><em>ptmout.txt</em>.</li><li>Navigate to the directory,</li></ol></li></ol></li></ol><p><em>\\{DSM2_home}\tutorials\historical\ptm-animate\dual\left_panel</em></p><ol><li><ol><li><ol><li>Paste the files in the<span> </span><em>left_panel</em><span> </span>directory.</li></ol></li></ol></li></ol><p><br/></p><ol><li><strong>Repeat with</strong><span> </span><strong>Dispersions Parameters Turned Off:</strong><ol><li>In Windows Explorer, navigate to the directory, _\\{DSM2_home}\tutorials\historical_</li><li>Open the file,<span> </span><em>historical_ptm.inp</em>.<ol><li>Locate the SCALARS section.</li><li>Change all of the dispersion parameters from<span> </span><em>t</em><span> </span>to<span> </span><em>f</em>.</li></ol></li></ol></li></ol><p>ptm_ivert<span> </span><em>f</em><span> </span># Use Vertical velocity profile<br/>ptm_itrans<span> </span><em>f</em><span> </span># Use Transverse velocity profile<br/>ptm_iey<span> </span><em>f</em><span> </span># Use transverse mixing<br/>ptm_iez<span> </span><em>f</em><span> </span># Use vertical mixing</p><ol><li><ol><li>In the command window, type:<span> </span><em>ptm historical_ptm.inp</em>.</li><li>In Windows Explorer:<ol><li>Navigate to the directory,</li></ol></li></ol></li></ol><p><em>\\{DSM2_home}\tutorials\historical\output</em></p><ol><li><ol><li><ol><li>Copy the files,<span> </span><em>anim_db.bin</em><span> </span>and<span> </span><em>ptmout.txt</em>.</li><li>Navigate to the directory,</li></ol></li></ol></li></ol><p><em>\\{DSM2_home}\tutorials\historical\ptm-animate\dual\right_panel</em></p><ol><li><ol><li><ol><li>Paste the files in the<span> </span><em>right_panel</em><span> </span>directory.</li><li>Navigate to the directory,</li></ol></li></ol></li></ol><p><em>\\{DSM2_home}\tutorials\historical\ptm-animate</em></p><ol><li><ol><li><ol><li>Double-click on<span> </span><em>dual.bat</em><span> </span>to open the animator.</li><li>Press start to start the animator and use the controls to adjust the speed.</li></ol></li></ol></li></ol><p><br/></p><ol><li><strong>Modifying the Animator Display:</strong><ol><li>The<span> </span><em>left_panel</em><span> </span>and<span> </span><em>right_panel</em><span> </span>directories contain files needed for operation:<ol><li>Modify the data path names:<span> </span><em>fluxInfoDB.data</em><span> </span>stores file and path information for the PTM output (the flux output in the text file is labeled with DSS-like path names). The listings in this file will be turned into the small flux bar graphs you see in the animator. The integer you see above the file name is an internal node ID, which is how you assign locations in the animator (also see<span> </span><em>network.dat</em><span> </span>below). Also, an output file of the PTM version 8 contains a minor version number. So the user may need to modify the data path names in the<span> </span><em>fluxInfoDB.data</em><span> </span>according to corresponding path names in an output file,<span> </span><em>ptmout.txt</em><span> </span>in this example.</li><li><em>labelsDB.data</em><span> </span>stores label information. You list labels and their location (using nodes, see<span> </span><em>network.dat</em><span> </span>below)</li><li><em>network.dat</em><span> </span>stores internal<span> </span><em>x-</em><span> </span>and<span> </span><em>y-</em>locations for nodes and channels. Pseudo-nodes are used for labels and other annotations as noted above. Please note that the nodes that are used in<span> </span><em>network.dat</em><span> </span>are internal node numbers, not external. (This makes the file very hard to edit, a point that will probably be addressed in the future). If you want a mapping of external-to-internal numbers, look at your echoed hydro output file (*.out or *.hof).</li></ol></li><li>Examine these files and the labels in them. Change the labels to something creative and reopen the animator.</li></ol></li></ol>
                    </div>

                                        
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on May 16, 2023 11:04</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
