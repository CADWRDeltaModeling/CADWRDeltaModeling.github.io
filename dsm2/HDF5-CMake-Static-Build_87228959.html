<!DOCTYPE html>
<html>
    <head>
        <title>DSM2 version 8.2 : HDF5 CMake Static Build</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">DSM2 version 8.2</a></span>
                            </li>
                                                    <li>
                                <span><a href="DSM2_87228545.html">DSM2</a></span>
                            </li>
                                                    <li>
                                <span><a href="Developer-and-Build_87228890.html">Developer and Build</a></span>
                            </li>
                                                    <li>
                                <span><a href="CMake-Build_87228956.html">CMake Build</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            DSM2 version 8.2 : HDF5 CMake Static Build
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Nicky Sandhu</span> on Jan 27, 2021
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>DSM2 binaries are built with static links (no DLLs are needed). However HDF5 1.8.10+ does not support static builds as there are fundamental problems if parallel support is enabled. However DSM2 does not need the parallel support and static builds are very convenient for us.</p><p>The information here was documented in 
<span class="jira-issue resolved" data-jira-key="DSM2-117" >
                    <a href="http://msb-jira/browse/DSM2-117?src=confmacro" class="jira-issue-key"><img class="icon"
                                                                                      src="http://msb-jira/secure/viewavatar?size=xsmall&amp;avatarId=10318&amp;avatarType=issuetype"/>DSM2-117</a>
                            -
            <span class="summary">Update HDF5 library to 1.8.19 or later</span>
                                                <span class="aui-lozenge aui-lozenge-subtle             aui-lozenge-success
     jira-macro-single-issue-export-pdf">Done</span>
                </span>
 and the kernel of information is included here for future HDF5 builds for static linking.</p></div></div><p><br/></p><h1 id="HDF5CMakeStaticBuild-Thisblogentryexplainshowtobuildwith/MTflag">This blog entry explains how to build with /MT flag</h1><p><a rel="nofollow" class="external-link" href="https://blog.afach.de/?page_id=421">https://blog.afach.de/?page_id=421</a></p><h1 id="HDF5CMakeStaticBuild-HDF5Static(with/MTflag)compilationAutocompilescript–VisualStudio">HDF5 Static (with /MT flag) compilation Auto compile script – Visual Studio</h1><p>This is a compile script that compiles HDF5 libraries from source statically with multithread support, i.e., “/MT” flag in Visual Studio. automatically.</p><h3 id="HDF5CMakeStaticBuild-Warning">Warning</h3><p>After discussing with one of the programmers of HDF5, it was made clear that linking statically works safely only in the condition HDF5 library wasn’t compiled with parallel support.</p><h3 id="HDF5CMakeStaticBuild-Thescript">The script</h3><p>The script involves going to the file<br/>config\cmake\UserMacros\Windows_MT.cmake<br/>and copying the file’s contents to “UserMacros.cmake”. The same is also done for ZLib and SZip after extracting them, and rezipping them again.</p><pre>@echo off
::The following is the name of the folder of HDF5 source
set &quot;hdffolder=hdf5-1.8.16&quot;

::add a new line then add /MT compilation options
call echo &amp; echo. &gt;&gt; %hdffolder%\UserMacros.cmake
cat %hdffolder%\config\cmake\UserMacros\Windows_MT.cmake &gt;&gt; %hdffolder%\UserMacros.cmake
for %%i in (%hdffolder%\UserMacros.cmake) do sed -i &quot;s/\&quot;Build With Static CRT Libraries\&quot; OFF/\&quot;Build With Static CRT Libraries\&quot; ON/g&quot; %%i

::add a new line then add /MT to SZip after extracting it, and then recompress it
gzip -dc SZip.tar.gz | tar -xf -
mv SZip.tar.gz SZip-dynamic.tar.gz
call echo &amp; echo. &gt;&gt; UserMacros.cmake
cat SZip\config\cmake\UserMacros\Windows_MT.cmake &gt;&gt;SZip\UserMacros.cmake
for %%i in (SZip\UserMacros.cmake) do sed -i &quot;s/\&quot;Build With Static CRT Libraries\&quot; OFF/\&quot;Build With Static CRT Libraries\&quot; ON/g&quot; %%i
tar cf SZip.tar SZip\
gzip SZip.tar
rm -r SZip

::do the same to ZLib
gzip -dc ZLib.tar.gz | tar -xf -
mv ZLib.tar.gz ZLib-dynamic.tar.gz
call echo &amp; echo. &gt;&gt; UserMacros.cmake
cat ZLib\config\cmake\UserMacros\Windows_MT.cmake &gt;&gt;ZLib\UserMacros.cmake
for %%i in (ZLib\UserMacros.cmake) do sed -i &quot;s/\&quot;Build With Static CRT Libraries\&quot; OFF/\&quot;Build With Static CRT Libraries\&quot; ON/g&quot; %%i
tar cf ZLib.tar ZLib\
gzip ZLib.tar
rm -r ZLib

build-VS2013-32.bat</pre><h3 id="HDF5CMakeStaticBuild-Requirements">Requirements</h3><p>1- <a rel="nofollow" href="http://www.cmake.org/download/" class="external-link">CMake</a> (add its executable folder to path)<br/>2- [GOW</p><div class="table-wrap"><table style="margin-left: 2.0px;" class="confluenceTable"><colgroup><col/></colgroup><tbody><tr><td class="confluenceTd"><a href="https://github.com/bmatzelle/gow/downloads]3-" class="external-link" rel="nofollow">https://github.com/bmatzelle/gow/downloads]3-</a> <a class="external-link" href="https://www.visualstudio.com/en-us/products/visual-studio-express-vs.aspx" rel="nofollow">Visual Studio or C++ Express</a> (this you can get for free from Microsoft, but I assume you know enough about this already since you’re here)</td></tr></tbody></table></div><p><br/></p><p>Note: If CMake won’t show in path in command prompt, run prompt as administrator, or use this command to add the path you want to the environment variable %PATH%<br/> set PATH=C:\Program Files (x86)\CMake\bin;%PATH%<br/> </p><p>Gow is GNU tools for windows, like tar, gzip and sed. These are important for the script.</p><p>Whether you’d like to have a 32-bit or 64-bit version of visual studio used depends on the environment variables that are defined. The easiest way is to run the run command prompt for the version you want. For example, in Visual Studio 2013, if one goes to Start, then types in quick search “Visual”, you’ll find a folder called “Visual Studio Tools”. This folder will have both command prompts with the relevant environment variables. The following shows this folder:</p><p><a href="https://blog.afach.de/wp-content/uploads/2015/07/VisualStudioCMDShortcuts.jpg" class="external-link" rel="nofollow"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-external-resource" height="317" width="668" src="https://blog.afach.de/wp-content/uploads/2015/07/VisualStudioCMDShortcuts.jpg" data-image-src="https://blog.afach.de/wp-content/uploads/2015/07/VisualStudioCMDShortcuts.jpg"></span></a></p><h3 id="HDF5CMakeStaticBuild-Preparetorunthescript">Prepare to run the script</h3><p>Go to <a class="external-link" rel="nofollow" href="https://support.hdfgroup.org/HDF5/release/">this page</a>, and download the CMake source. Extract it; put the script in a file there; if the version you want to compile is different than the one in the script, modify the folder name; and finally run the script. After the script is finished, you’ll have a compressed zip file with compiled source and an installer executable.</p><p><a href="https://blog.afach.de/wp-content/uploads/2015/07/HDF5FolderLook.gif" class="external-link" rel="nofollow"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-external-resource" height="306" width="640" src="https://blog.afach.de/wp-content/uploads/2015/07/HDF5FolderLook.gif" data-image-src="https://blog.afach.de/wp-content/uploads/2015/07/HDF5FolderLook.gif"></span></a>The file HDF5CompileScript.bat is where I copied the script of compile that I created. Just run this script through the command prompt of visual studio and it’ll compile.</p><p> </p>
                    </div>

                                        
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on May 16, 2023 11:04</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
